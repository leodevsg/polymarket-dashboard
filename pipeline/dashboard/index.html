<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Polymarket Arb Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:20px}
    h1{margin-bottom:6px}
    .row{display:flex;gap:20px}
    .card{border:1px solid #ddd;padding:12px;border-radius:6px;background:#fff;flex:1}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
    .small{font-size:12px;color:#666}
    .loading{color:#888}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>Polymarket Arb Dashboard</h1>
  <p class="small">Interactive dashboard. Data loaded from CSV files in repository.</p>

  <div class="row">
    <div class="card" style="flex:1.2">
      <h3>Top Arb Candidates</h3>
      <div id="top-table" class="loading">Loading...</div>
    </div>
    <div class="card" style="flex:0.8">
      <h3>Quick Metrics</h3>
      <div id="metrics" class="loading">Loading...</div>
    </div>
  </div>

  <div class="row" style="margin-top:18px">
    <div class="card">
      <h3>Simulation Distribution (Net)</h3>
      <canvas id="histChart" height="120"></canvas>
    </div>
    <div class="card">
      <h3>Recent Trades / Sim Detail</h3>
      <div id="sim-table" class="loading">Loading...</div>
    </div>
  </div>

<script>
const base = '/pipeline/sample_output/';
const paths = {
  top: base + 'arb_sim_top.csv',
  sim_detail: base + 'arb_paper_sim_detail.csv',
  arb_results: base + 'arb_sim_results.csv'
};

async function fetchCSV(path){
  // simple fetch + CSV parse (fallback to avoid CORS/XHR issues on some mobile browsers)
  try{
    const r = await fetch(path);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    const lines = txt.split(/?
/).filter(Boolean);
    if(lines.length===0) return [];
    const headers = lines[0].split(',').map(h=>h.trim());
    const out = [];
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',');
      const obj = {};
      for(let j=0;j<headers.length;j++) obj[headers[j]] = cols[j]===undefined? '': cols[j];
      out.push(obj);
    }
    return out;
  }catch(e){
    // fallback to papa parse if available
    return new Promise((res,rej)=>{
      if(window.Papa){
        Papa.parse(path, {download:true, header:true, skipEmptyLines:true, complete: (r)=>res(r.data), error: (err)=>rej(err)});
      } else rej(e);
    });
  }
}

function safeText(v){ return v==null? '': String(v); }

async function render(){
  try{
    const [top, sim, results] = await Promise.all([
      fetchCSV(paths.top),
      fetchCSV(paths.sim_detail),
      fetchCSV(paths.arb_results)
    ]);

    const topDiv = document.getElementById('top-table');
    if(!top || top.length==0){ topDiv.innerText='No top candidates file found.'; } else {
      let html='<table><thead><tr><th>group</th><th>markets</th><th>sum_yes</th><th>n</th><th>net(0.5%)</th></tr></thead><tbody>';
      top.slice(0,50).forEach(r=>{ html+=`<tr><td>${safeText(r.group)}</td><td style="max-width:260px;white-space:nowrap;overflow:auto">${safeText(r.market_ids)}</td><td>${safeText(r.sum_yes)}</td><td>${safeText(r.n_markets)}</td><td>${safeText(r.net_0.5pct)}</td></tr>`});
      html+='</tbody></table>';
      topDiv.innerHTML=html;
    }

    const metrics = document.getElementById('metrics');
    if(sim && sim.length>0){
      const nets = sim.map(r=>parseFloat(r.net_0.5)).filter(v=>!isNaN(v));
      const total = (nets.reduce((a,b)=>a+b,0)).toFixed(2);
      const mean = (nets.length? (total / nets.length).toFixed(2) : '0.00');
      metrics.innerHTML = `<p>Sim trials: <b>${nets.length}</b></p><p>Total net (0.5%): <b>$${total}</b></p><p>Mean per trial: <b>$${mean}</b></p>`;
    } else {
      metrics.innerText='No sim detail file found.';
    }

    const ctx = document.getElementById('histChart').getContext('2d');
    const values = sim.map(r=>parseFloat(r.net_0.5)).filter(v=>!isNaN(v));
    if(values.length>0){
      const bins=20; const min=Math.min(...values); const max=Math.max(...values); const step=(max-min)/bins || 1; const hist=new Array(bins).fill(0);
      values.forEach(v=>{ let i=Math.floor((v-min)/step); if(i<0)i=0; if(i>=bins) i=bins-1; hist[i]++; });
      const labels=Array.from({length:bins},(_,i)=> (min + i*step).toFixed(1));
      new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Counts',data:hist,backgroundColor:'#36a2eb'}]}, options:{responsive:true}});
    }

    const simDiv = document.getElementById('sim-table');
    if(sim && sim.length>0){
      let html='<table><thead><tr><th>trial</th><th>group</th><th>net_0.5</th><th>net_1</th><th>net_2</th></tr></thead><tbody>';
      sim.slice(-100).reverse().forEach(r=>{ html+=`<tr><td>${safeText(r.trial)}</td><td>${safeText(r.group)}</td><td>${safeText(r.net_0.5)}</td><td>${safeText(r.net_1)}</td><td>${safeText(r.net_2)}</td></tr>`});
      html+='</tbody></table>';
      simDiv.innerHTML=html;
    } else simDiv.innerText='No sim details available.';

  }catch(e){ console.error(e); document.body.insertAdjacentHTML('beforeend','<p style="color:red">Error loading CSVs or rendering dashboard: '+e+'</p>'); }
}

render();
</script>
</body>
</html>